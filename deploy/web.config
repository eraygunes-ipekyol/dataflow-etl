<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>

    <!-- Static content MIME types -->
    <staticContent>
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <remove fileExtension=".woff" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <remove fileExtension=".woff2" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
    </staticContent>

    <!-- WebSocket desteği aktif — ARR reverse proxy WS upgrade yapabilir -->
    <webSocket enabled="true" />

    <!-- URL Rewrite kuralları -->
    <rewrite>
      <rules>

        <!-- Kural 1: WebSocket Proxy — /ws/api/v1/* → backend (prefix strip) -->
        <rule name="WebSocket Proxy" stopProcessing="true">
          <match url="^ws/api/v1/(.*)" />
          <conditions>
            <add input="{HTTP_UPGRADE}" pattern="websocket" ignoreCase="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:8445/api/v1/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="https" />
          </serverVariables>
        </rule>

        <!-- Kural 1b: WebSocket fallback — upgrade olmadan gelen ws/ istekleri de backend'e gitsin -->
        <rule name="WebSocket Fallback" stopProcessing="true">
          <match url="^ws/api/v1/(.*)" />
          <action type="Rewrite" url="http://localhost:8445/api/v1/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="https" />
          </serverVariables>
        </rule>

        <!-- Kural 2: API Proxy — /api/v1/* → backend -->
        <rule name="API Proxy" stopProcessing="true">
          <match url="^api/v1/(.*)" />
          <action type="Rewrite" url="http://localhost:8445/api/v1/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="https" />
            <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}" />
          </serverVariables>
        </rule>

        <!-- Kural 3: Frontend Static Files — frontend/ altındaki dosyaları sun -->
        <rule name="Frontend Static" stopProcessing="true">
          <match url="^(?!api/|ws/|frontend/|backend/)(.*)" />
          <conditions logicalGrouping="MatchAll">
            <add input="{APPL_PHYSICAL_PATH}frontend\{R:1}" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="frontend/{R:1}" />
        </rule>

        <!-- Kural 4: SPA Fallback — dosya bulunamazsa → index.html -->
        <rule name="SPA Fallback" stopProcessing="true">
          <match url="^(?!api/|ws/|frontend/|backend/)(.*)" />
          <action type="Rewrite" url="frontend/index.html" />
        </rule>

      </rules>
    </rewrite>

    <!-- Default document -->
    <defaultDocument>
      <files>
        <clear />
        <add value="frontend/index.html" />
      </files>
    </defaultDocument>

    <!-- Güvenlik: backend dizinine doğrudan erişimi engelle -->
    <security>
      <requestFiltering>
        <hiddenSegments>
          <add segment="backend" />
        </hiddenSegments>
      </requestFiltering>
    </security>

  </system.webServer>
</configuration>
